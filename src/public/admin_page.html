<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Haven Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="styles/adminstyle.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar - Navigation -->
        <nav class="servers-bar">
            <div class="home-button">
                <i class="fas fa-home"></i>
            </div>
            <div class="server-separator"></div>
            <div class="global-chat" title="Global Chat">
                <i class="fas fa-globe"></i>
            </div>
            <div class="teams-list" id="teams-list"></div>
            <div class="add-server" title="Create Team">
                <i class="fas fa-plus"></i>
            </div>
        </nav>

        <!-- Middle Bar - Friends List -->
        <aside class="channels-sidebar">
            <div class="friends-header">
                <h3>Friends</h3>
                <i class="fas fa-user-plus add-friend-icon"></i>
            </div>

            <div class="friends-section">
                <!-- Online Friends Category -->
                <div class="friends-category">
                    <div class="category-header">
                        <span>ONLINE â€” <span id="online-count">0</span></span>
                    </div>
                    <div class="friends-list" id="online-friends"></div>
                </div>

                <!-- Offline Friends Category -->
                <div class="friends-category">
                    <div class="category-header">
                        <span>OFFLINE â€” <span id="offline-count">0</span></span>
                    </div>
                    <div class="friends-list" id="offline-friends"></div>
                </div>

                <!-- Other Users Section -->
                <div class="other-users-section">
                    <div class="category-header">
                        <span>OTHER USERS</span>
                        <button class="view-all-btn">View All</button>
                    </div>
                    <div class="other-users-list" id="other-users"></div>
                </div>
            </div>

            <!-- User Profile -->
            <div class="user-profile">
                <div class="profile-info">
                    <div class="profile-avatar">
                        <i class="fas fa-user"></i>
                        <div class="status-indicator status-online"></div>
                    </div>
                    <div class="profile-details">
                        <div class="profile-name">
                            <span id="admin-name">jnnj</span>
                            <span class="role-badge role-admin">Admin</span>
                        </div>
                        <div class="profile-status">
                            <i class="fas fa-circle status-online"></i>
                            Online
                        </div>
                    </div>
                </div>
                <div class="profile-actions">
                    <button class="action-btn" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="action-btn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="content-area">
            <div class="content-header">
                <div class="header-title">
                    <i class="fas fa-user-friends"></i>
                    <h2>Friends</h2>
                </div>
                <div class="header-tabs">
                    <button class="tab-btn active">Add Friend</button>
                    <button class="tab-btn">Pending</button>
                </div>
            </div>

            <!-- Add Friend Section -->
            <div class="add-friend-section">
                <h2>ADD FRIEND</h2>
                <p>You can add friends with their Chat Haven username.</p>
                <div class="add-friend-form">
                    <input type="text" id="friend-username" placeholder="Enter a username">
                    <button class="send-friend-request">Send Friend Request</button>
                </div>
            </div>

            <!-- Friends Display -->
            <div class="friends-display">
                <!-- Friends will be listed here -->
            </div>
        </main>
    </div>
    <!-- Chat Container -->
    <div id="chat-container" class="chat-container">
        <div class="chat-backdrop"></div>
        <div class="chat-content">
            <div id="chat-header">
                <h3 id="Chat-title">Global Chat</h3>
                <button id="close-chat">Ã—</button>
            </div>
            <div id="chat-messages" class="messages-area"></div>
            <div id="chat-input">
                <input type="text" id="message" placeholder="Type a message...">
                <button id="emoji-btn">ðŸ˜Š</button>
                <button id="send">Send</button>
            </div>
        </div>
        <div id="emoji-picker-container" style="display: none;"></div>
    </div>
    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Team Creation View (Initially Hidden) -->
    <div id="team-creation-view" class="team-creation-view">
        <div class="content-header">
            <div class="header-title">
                <i class="fas fa-users"></i>
                <h2>Create New Team</h2>
            </div>
        </div>

        <div class="team-creation-section">
            <div class="team-creation-form">
                <div class="form-group">
                    <label for="team-name">Team Name</label>
                    <input type="text" id="team-name" placeholder="Enter team name" required>
                </div>
                
                <div class="form-group">
                    <label>Add Team Members</label>
                    <div class="member-input-container">
                        <input type="text" id="member-search" placeholder="Search users by username">
                        <button id="search-user-btn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div id="user-search-results" class="user-search-results"></div>
                </div>

                <div class="selected-members">
                    <h3>Selected Members</h3>
                    <div id="selected-members-list" class="selected-members-list"></div>
                </div>

                <div class="form-actions">
                    <button id="create-team-btn" class="create-team-btn">
                        <i class="fas fa-plus"></i>
                        Create Team
                    </button>
                    <button id="cancel-creation-btn" class="cancel-btn">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io('ws://localhost:3000');
        let loggedInUser, loggedInUserId;
    
        // Toast functionality
            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerText = message;
                document.getElementById('toast-container').appendChild(toast);
                setTimeout(() => {
                    toast.classList.add('hide');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
            }
           
        // Fetch admin info and setup user status
            fetch('/admin-info')
                .then(response => {
                    if (!response.ok) throw new Error('Unauthorized');
                    return response.json();
                })
                .then(data => {
                    document.getElementById('admin-name').textContent = data.name;
                    document.addEventListener("click", () => resetInactivityTimer(data.name));
                    document.addEventListener("keydown", () => resetInactivityTimer(data.name));
                    socket.emit("userOnline", data.name);
                })
                .catch(() => window.location.href = '/login_form.html');
    
        // Chat and Status functionality
    document.addEventListener("DOMContentLoaded", () => {
        const chatContainer = document.getElementById("chat-container");
        const closeChat = document.getElementById("close-chat");
        const sendButton = document.getElementById("send");
        const messageInput = document.getElementById("message");
        const chatMessages = document.getElementById("chat-messages");
            const statusContainer = document.getElementById("status-container");
        const closeStatus = document.getElementById("close-status");
    
            // Global chat button functionality
            const globalChatBtn = document.querySelector('.global-chat');
            globalChatBtn.addEventListener("click", () => {
                chatContainer.style.left = "0";
                document.body.style.overflow = 'hidden'; // Prevent scrolling of background
            });
    
            closeChat.addEventListener("click", () => {
                chatContainer.style.left = "-100%";
                document.body.style.overflow = 'auto'; // Re-enable scrolling
            });
    
            // Message sending functionality
            function sendMessage() {
                const message = messageInput.value.trim();
                if (message) {
                    socket.emit('message', { text: message });
                    messageInput.value = '';
                }
            }
    
            sendButton.addEventListener("click", sendMessage);
        messageInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") sendMessage();
            });
    
            // Load and display stored messages
            let messages = JSON.parse(sessionStorage.getItem("chatMessages")) || [];
            
        function displayMessage(msg) {
            fetch('/user-info')
                    .then(response => response.json())
                .then(data => {
                    loggedInUser = data.name;
                    loggedInUserId = data.id;
                        messages.forEach((msg) => {
        const messageElement = document.createElement("div");
                            messageElement.classList.add(
                                msg.senderID === loggedInUserId ? "my-message" : "other-message"
                            );
                            messageElement.textContent = msg.senderID === loggedInUserId ? 
                                msg.text : `${msg.sender}: ${msg.text}`;
        chatMessages.appendChild(messageElement);
                        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
                    });
            }
    
            displayMessage(messages);
    
            // Handle incoming messages
        socket.on("message", (msg) => {
            const messageElement = document.createElement("div");
                if (loggedInUserId === msg.userID) {
                messageElement.classList.add("my-message");
                    messageElement.textContent = msg.text;
                } else {
                messageElement.classList.add("other-message");
                messageElement.textContent = `${msg.user}: ${msg.text}`;
                }
                messages.push({
                    id: messages.length + 1,
                    text: msg.text,
                    sender: msg.user,
                    senderID: msg.userID,
                    timestamp: Date.now()
                });
                sessionStorage.setItem("chatMessages", JSON.stringify(messages));
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight; 
            messageInput.value = "";
        });
    
            // Emoji picker functionality
            const emojiBtn = document.getElementById("emoji-btn");
            const pickerContainer = document.getElementById("emoji-picker-container");
    
            emojiBtn.addEventListener("click", (event) => {
                event.stopPropagation();
                if (pickerContainer.style.display === "none") {
                    pickerContainer.style.display = "block";
                    if (pickerContainer.innerHTML === "") {
                        const picker = new EmojiMart.Picker({
                            set: 'apple',
                            onEmojiSelect: (emoji) => {
                                messageInput.value += emoji.native;
                                pickerContainer.style.display = "none";
                            }
                        });
                        pickerContainer.appendChild(picker);
                    }
                } else {
                    pickerContainer.style.display = "none";
                }
            });
    
            // Close emoji picker when clicking outside
            document.addEventListener("click", (event) => {
                if (!pickerContainer.contains(event.target) && event.target !== emojiBtn) {
                    pickerContainer.style.display = "none";
                }
            });
    
            // User status updates
            socket.on("updateUserStatus", ({ online, away }) => {
                fetch("/api/users")
                    .then(response => response.json())
                    .then(data => {
                        updateUserStatusUI(data.all_users, online, away, data.user_logout_times);
                    });
            });
        });
    
        // Inactivity timer
        let inactivityTimer;
        const INACTIVITY_TIME = 30000;
    
        function resetInactivityTimer(userId) {
            clearTimeout(inactivityTimer);
            socket.emit("userOnline", userId);
            inactivityTimer = setTimeout(() => {
                socket.emit("userAway", userId);
            }, INACTIVITY_TIME);
        }

        // Team creation functionality
        document.querySelector('.add-server').addEventListener('click', () => {
            const teamCreationView = document.getElementById('team-creation-view');
            teamCreationView.style.display = 'block';
            document.body.style.overflow = 'hidden';
        });

        function createTeamIcon(teamName) {
            const teamIcon = document.createElement('div');
            teamIcon.className = 'team-icon';
            teamIcon.textContent = teamName.substring(0, 2).toUpperCase();
            teamIcon.title = teamName;
            
            teamIcon.addEventListener('click', () => {
                // Remove active class from all team icons
                document.querySelectorAll('.team-icon').forEach(icon => icon.classList.remove('active'));
                // Add active class to clicked icon
                teamIcon.classList.add('active');
                
                // Here you can add the logic to show team functionality
                // For example, updating the main content area with team chat, members, etc.
            });
            
            return teamIcon;
        }

        function loadTeams() {
            console.log('Loading teams...');
            fetch('/api/teams', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`Failed to load teams: ${response.status}`);
                }
                return response.json();
            })
            .then(teams => {
                console.log('Teams received:', teams);
                if (!Array.isArray(teams)) {
                    throw new Error('Invalid teams data received');
                }
                
                const teamsList = document.getElementById('teams-list');
                if (!teamsList) {
                    throw new Error('Teams list container not found');
                }
                
                teamsList.innerHTML = ''; // Clear existing teams
                
                if (teams.length === 0) {
                    console.log('No teams available');
                    return;
                }
                
                teams.forEach(team => {
                    console.log('Creating icon for team:', team.name);
                    const teamIcon = createTeamIcon(team.name);
                    teamsList.appendChild(teamIcon);
                });
            })
            .catch(error => {
                console.error('Error loading teams:', error);
                showToast('Error loading teams. Please refresh the page.', 'error');
            });
        }

        function initializeTeamCreation() {
            const teamNameInput = document.getElementById('team-name');
            const memberSearch = document.getElementById('member-search');
            const searchBtn = document.getElementById('search-user-btn');
            const userResults = document.getElementById('user-search-results');
            const selectedMembersList = document.getElementById('selected-members-list');
            const createTeamBtn = document.getElementById('create-team-btn');
            const cancelBtn = document.getElementById('cancel-creation-btn');
            const teamCreationView = document.getElementById('team-creation-view');

            const selectedMembers = new Set();

            // Search users functionality
            searchBtn.addEventListener('click', () => {
                const searchTerm = memberSearch.value.trim();
                if (searchTerm) {
                    fetch('/api/users')
                        .then(response => response.json())
                        .then(data => {
                            const filteredUsers = data.all_users.filter(user => 
                                user.name.toLowerCase().includes(searchTerm.toLowerCase()) &&
                                !selectedMembers.has(user.name)
                            );
                            
                            userResults.innerHTML = '';
                            filteredUsers.forEach(user => {
                                const userItem = document.createElement('div');
                                userItem.className = 'user-result-item';
                                userItem.innerHTML = `
                                    <span>${user.name}</span>
                                    <button class="add-member-btn">Add</button>
                                `;
                                
                                userItem.querySelector('button').addEventListener('click', () => {
                                    addMember(user.name);
                                    userResults.removeChild(userItem);
                                });
                                
                                userResults.appendChild(userItem);
                            });
                        })
                        .catch(error => showToast('Error searching users', 'error'));
                }
            });

            // Add member function
            function addMember(username) {
                if (!selectedMembers.has(username)) {
                    selectedMembers.add(username);
                    const memberTag = document.createElement('div');
                    memberTag.className = 'selected-member-tag';
                    memberTag.innerHTML = `
                        <span>${username}</span>
                        <button class="remove-member-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    memberTag.querySelector('button').addEventListener('click', () => {
                        selectedMembers.delete(username);
                        selectedMembersList.removeChild(memberTag);
                    });
                    
                    selectedMembersList.appendChild(memberTag);
                }
            }

            // Updated create team functionality
            createTeamBtn.addEventListener('click', async () => {
                const teamName = teamNameInput.value.trim();
                if (!teamName) {
                    showToast('Please enter a team name', 'error');
                    return;
                }

                try {
                    const createTeamResponse = await fetch('/create-team', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ teamName })
                    });
                    const teamData = await createTeamResponse.json();

                    if (teamData.error) {
                        throw new Error(teamData.error);
                    }

                    const teamIdResponse = await fetch(`/get-team-id?teamName=${encodeURIComponent(teamName)}`);
                    const { teamId } = await teamIdResponse.json();

                    // Add members to the team
                    for (const member of selectedMembers) {
                        await fetch('/assign-user-to-team', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ teamId, userName: member })
                        });
                    }

                    // Create and add the team icon
                    const teamsList = document.getElementById('teams-list');
                    const teamIcon = createTeamIcon(teamName);
                    teamsList.appendChild(teamIcon);

                    showToast('Team created successfully!', 'success');
                    teamCreationView.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    
                    // Clear form
                    teamNameInput.value = '';
                    selectedMembers.clear();
                    selectedMembersList.innerHTML = '';
                    
                } catch (error) {
                    showToast(error.message || 'Error creating team', 'error');
                }
            });

            // Cancel button functionality
            cancelBtn.addEventListener('click', () => {
                teamCreationView.style.display = 'none';
                document.body.style.overflow = 'auto';
            });
        }

        // Load teams when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, checking authentication...');
            // First check if user is authenticated
            fetch('/admin-info')
                .then(response => {
                    console.log('Auth response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Unauthorized');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('User authenticated:', data);
                    // User is authenticated, initialize everything
                    document.getElementById('admin-name').textContent = data.name;
                    initializeTeamCreation();
                    loadTeams(); // Load teams after confirming authentication
                    
                    // Set up activity listeners
                    document.addEventListener("click", () => resetInactivityTimer(data.name));
                    document.addEventListener("keydown", () => resetInactivityTimer(data.name));
                    socket.emit("userOnline", data.name);
                })
                .catch(error => {
                    console.error('Authentication error:', error);
                    if (error.message === 'Unauthorized') {
                        window.location.href = '/login_form.html';
                    }
                });
        });
    </script>
</body>
</html>
